"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[4190],{9971:(t,e,n)=>{n.r(e),n.d(e,{assets:()=>i,contentTitle:()=>c,default:()=>h,frontMatter:()=>o,metadata:()=>r,toc:()=>l});const r=JSON.parse('{"id":"guide/testing","title":"Testing","description":"Testing handler and middleware","source":"@site/docs/guide/testing.md","sourceDirName":"guide","slug":"/testing","permalink":"/docs/testing","draft":false,"unlisted":false,"editUrl":"https://github.com/labstack/echox/blob/master/website/docs/guide/testing.md","tags":[],"version":"current","sidebarPosition":13,"frontMatter":{"description":"Testing handler and middleware","slug":"/testing","sidebar_position":13},"sidebar":"docsSidebar","previous":{"title":"Templates","permalink":"/docs/templates"},"next":{"title":"Middleware","permalink":"/docs/category/middleware"}}');var s=n(4848),a=n(8453);const o={description:"Testing handler and middleware",slug:"/testing",sidebar_position:13},c="Testing",i={},l=[{value:"Testing Handler",id:"testing-handler",level:2},{value:"CreateUser",id:"createuser",level:3},{value:"GetUser",id:"getuser",level:3},{value:"Using Form Payload",id:"using-form-payload",level:3},{value:"Setting Path Params",id:"setting-path-params",level:3},{value:"Setting Query Params",id:"setting-query-params",level:3},{value:"Testing Middleware",id:"testing-middleware",level:2}];function d(t){const e={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,a.R)(),...t.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(e.header,{children:(0,s.jsx)(e.h1,{id:"testing",children:"Testing"})}),"\n",(0,s.jsx)(e.h2,{id:"testing-handler",children:"Testing Handler"}),"\n",(0,s.jsxs)(e.p,{children:[(0,s.jsx)(e.code,{children:"GET"})," ",(0,s.jsx)(e.code,{children:"/users/:id"})]}),"\n",(0,s.jsxs)(e.p,{children:["Handler below retrieves user by id from the database. If user is not found it returns\n",(0,s.jsx)(e.code,{children:"404"})," error with a message."]}),"\n",(0,s.jsx)(e.h3,{id:"createuser",children:"CreateUser"}),"\n",(0,s.jsxs)(e.p,{children:[(0,s.jsx)(e.code,{children:"POST"})," ",(0,s.jsx)(e.code,{children:"/users"})]}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"Accepts JSON payload"}),"\n",(0,s.jsxs)(e.li,{children:["On success ",(0,s.jsx)(e.code,{children:"201 - Created"})]}),"\n",(0,s.jsxs)(e.li,{children:["On error ",(0,s.jsx)(e.code,{children:"500 - Internal Server Error"})]}),"\n"]}),"\n",(0,s.jsx)(e.h3,{id:"getuser",children:"GetUser"}),"\n",(0,s.jsxs)(e.p,{children:[(0,s.jsx)(e.code,{children:"GET"})," ",(0,s.jsx)(e.code,{children:"/users/:email"})]}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["On success ",(0,s.jsx)(e.code,{children:"200 - OK"})]}),"\n",(0,s.jsxs)(e.li,{children:["On error ",(0,s.jsx)(e.code,{children:"404 - Not Found"})," if user is not found otherwise ",(0,s.jsx)(e.code,{children:"500 - Internal Server Error"})]}),"\n"]}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.code,{children:"handler.go"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-go",children:'package handler\n\nimport (\n\t"net/http"\n\n\t"github.com/labstack/echo/v5"\n)\n\ntype (\n\tUser struct {\n\t\tName  string `json:"name" form:"name"`\n\t\tEmail string `json:"email" form:"email"`\n\t}\n\thandler struct {\n\t\tdb map[string]*User\n\t}\n)\n\nfunc (h *handler) createUser(c *echo.Context) error {\n\tu := new(User)\n\tif err := c.Bind(u); err != nil {\n\t\treturn err\n\t}\n\treturn c.JSON(http.StatusCreated, u)\n}\n\nfunc (h *handler) getUser(c *echo.Context) error {\n\temail := c.Param("email")\n\tuser := h.db[email]\n\tif user == nil {\n\t\treturn echo.NewHTTPError(http.StatusNotFound, "user not found")\n\t}\n\treturn c.JSON(http.StatusOK, user)\n}\n'})}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.code,{children:"handler_test.go"})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-go",children:'package handler\n\nimport (\n\t"net/http"\n\t"net/http/httptest"\n\t"strings"\n\t"testing"\n\n\t"github.com/labstack/echo/v5"\n\t"github.com/labstack/echo/v5/echotest"\n\t"github.com/stretchr/testify/assert"\n)\n\nvar (\n\tmockDB = map[string]*User{\n\t\t"jon@labstack.com": &User{"Jon Snow", "jon@labstack.com"},\n\t}\n\tuserJSON = `{"name":"Jon Snow","email":"jon@labstack.com"}`\n)\n\nfunc TestCreateUser(t *testing.T) {\n\t// Setup\n\te := echo.New()\n\treq := httptest.NewRequest(http.MethodPost, "/", strings.NewReader(userJSON))\n\treq.Header.Set(echo.HeaderContentType, echo.MIMEApplicationJSON)\n\n\trec := httptest.NewRecorder()\n\tc := e.NewContext(req, rec)\n\n\th := &controller{mockDB}\n\n\t// Assertions\n\tif assert.NoError(t, h.createUser(c)) {\n\t\tassert.Equal(t, http.StatusCreated, rec.Code)\n\t\tassert.Equal(t, userJSON, rec.Body.String())\n\t}\n}\n\n// Same test as above but using `echotest` package helpers\nfunc TestCreateUserWithEchoTest(t *testing.T) {\n\tc, rec := echotest.ContextConfig{\n\t\tHeaders: map[string][]string{\n\t\t\techo.HeaderContentType: {echo.MIMEApplicationJSON},\n\t\t},\n\t\tJSONBody: []byte(`{"name":"Jon Snow","email":"jon@labstack.com"}`),\n\t}.ToContextRecorder(t)\n\n\th := &controller{mockDB}\n\n\t// Assertions\n\tif assert.NoError(t, h.createUser(c)) {\n\t\tassert.Equal(t, http.StatusCreated, rec.Code)\n\t\tassert.Equal(t, userJSON+"\\n", rec.Body.String())\n\t}\n}\n\n// Same test as above but even shorter\nfunc TestCreateUserWithEchoTest2(t *testing.T) {\n\th := &controller{mockDB}\n\n\trec := echotest.ContextConfig{\n\t\tHeaders: map[string][]string{\n\t\t\techo.HeaderContentType: {echo.MIMEApplicationJSON},\n\t\t},\n\t\tJSONBody: []byte(`{"name":"Jon Snow","email":"jon@labstack.com"}`),\n\t}.ServeWithHandler(t, h.createUser)\n\n\tassert.Equal(t, http.StatusCreated, rec.Code)\n\tassert.Equal(t, userJSON+"\\n", rec.Body.String())\n}\n\nfunc TestGetUser(t *testing.T) {\n\t// Setup\n\te := echo.New()\n\treq := httptest.NewRequest(http.MethodGet, "/", nil)\n\trec := httptest.NewRecorder()\n\tc := e.NewContext(req, rec)\n\n\tc.SetPath("/users/:email")\n\tc.SetPathValues(echo.PathValues{\n\t\t{Name: "email", Value: "jon@labstack.com"},\n\t})\n\th := &controller{mockDB}\n\n\t// Assertions\n\tif assert.NoError(t, h.getUser(c)) {\n\t\tassert.Equal(t, http.StatusOK, rec.Code)\n\t\tassert.Equal(t, userJSON, rec.Body.String())\n\t}\n}\n\nfunc TestGetUserWithEchoTest(t *testing.T) {\n\tc, rec := echotest.ContextConfig{\n\t\tPathValues: echo.PathValues{\n\t\t\t{Name: "email", Value: "jon@labstack.com"},\n\t\t},\n\t\tHeaders: map[string][]string{\n\t\t\techo.HeaderContentType: {echo.MIMEApplicationJSON},\n\t\t},\n\t\tJSONBody: []byte(userJSON),\n\t}.ToContextRecorder(t)\n\n\th := &controller{mockDB}\n\n\t// Assertions\n\tif assert.NoError(t, h.getUser(c)) {\n\t\tassert.Equal(t, http.StatusOK, rec.Code)\n\t\tassert.Equal(t, userJSON+"\\n", rec.Body.String())\n\t}\n}\n'})}),"\n",(0,s.jsx)(e.h3,{id:"using-form-payload",children:"Using Form Payload"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-go",children:'// import "net/url"\nf := make(url.Values)\nf.Set("name", "Jon Snow")\nf.Set("email", "jon@labstack.com")\nreq := httptest.NewRequest(http.MethodPost, "/", strings.NewReader(f.Encode()))\nreq.Header.Set(echo.HeaderContentType, echo.MIMEApplicationForm)\n'})}),"\n",(0,s.jsx)(e.p,{children:"Multipart form payload:"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-go",children:'func TestContext_MultipartForm(t *testing.T) {\n\ttestConf := echotest.ContextConfig{\n\t\tMultipartForm: &echotest.MultipartForm{\n\t\t\tFields: map[string]string{\n\t\t\t\t"key": "value",\n\t\t\t},\n\t\t\tFiles: []echotest.MultipartFormFile{\n\t\t\t\t{\n\t\t\t\t\tFieldname: "file",\n\t\t\t\t\tFilename:  "test.json",\n\t\t\t\t\tContent:   echotest.LoadBytes(t, "testdata/test.json"),\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t}\n\tc := testConf.ToContext(t)\n\n\tassert.Equal(t, "value", c.FormValue("key"))\n\tassert.Equal(t, http.MethodPost, c.Request().Method)\n\tassert.Equal(t, true, strings.HasPrefix(c.Request().Header.Get(echo.HeaderContentType), "multipart/form-data; boundary="))\n\n\tfv, err := c.FormFile("file")\n\tif err != nil {\n\t\tt.Fatal(err)\n\t}\n\tassert.Equal(t, "test.json", fv.Filename)\n}\n'})}),"\n",(0,s.jsx)(e.h3,{id:"setting-path-params",children:"Setting Path Params"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-go",children:'c.SetPathValues(echo.PathValues{\n\t{Name: "id", Value: "1"},\n\t{Name: "email", Value: "jon@labstack.com"},\n})\n'})}),"\n",(0,s.jsx)(e.h3,{id:"setting-query-params",children:"Setting Query Params"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-go",children:'// import "net/url"\nq := make(url.Values)\nq.Set("email", "jon@labstack.com")\nreq := httptest.NewRequest(http.MethodGet, "/?"+q.Encode(), nil)\n'})}),"\n",(0,s.jsx)(e.h2,{id:"testing-middleware",children:"Testing Middleware"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-go",children:'func TestCreateUserWithEchoTest2(t *testing.T) {\n\thandler := func(c *echo.Context) error {\n\t\treturn c.JSON(http.StatusTeapot, fmt.Sprintf("email: %s", c.Param("email")))\n\t}\n\tmiddleware := func(next echo.HandlerFunc) echo.HandlerFunc {\n\t\treturn func(c *echo.Context) error {\n\t\t\tc.Set("user_id", int64(1234))\n\t\t\treturn next(c)\n\t\t}\n\t}\n\n\tc, rec := echotest.ContextConfig{\n\t\tPathValues: echo.PathValues{{Name: "email", Value: "jon@labstack.com"}},\n\t}.ToContextRecorder(t)\n\n\terr := middleware(handler)(c)\n\tif err != nil {\n\t\tt.Fatal(err)\n\t}\n\t// check that middleware set the value\n\tuserID, err := echo.ContextGet[int64](c, "user_id")\n\tassert.NoError(t, err)\n\tassert.Equal(t, int64(1234), userID)\n\n\t// check that handler returned the correct response\n\tassert.Equal(t, http.StatusTeapot, rec.Code)\n}\n'})}),"\n",(0,s.jsxs)(e.p,{children:["For now you can look into built-in middleware ",(0,s.jsx)(e.a,{href:"https://github.com/labstack/echo/tree/master/middleware",children:"test cases"}),"."]})]})}function h(t={}){const{wrapper:e}={...(0,a.R)(),...t.components};return e?(0,s.jsx)(e,{...t,children:(0,s.jsx)(d,{...t})}):d(t)}},8453:(t,e,n)=>{n.d(e,{R:()=>o,x:()=>c});var r=n(6540);const s={},a=r.createContext(s);function o(t){const e=r.useContext(a);return r.useMemo((function(){return"function"==typeof t?t(e):{...e,...t}}),[e,t])}function c(t){let e;return e=t.disableParentContext?"function"==typeof t.components?t.components(s):t.components||s:o(t.components),r.createElement(a.Provider,{value:e},t.children)}}}]);