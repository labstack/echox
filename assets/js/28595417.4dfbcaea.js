"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[2728],{7826:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>o,default:()=>u,frontMatter:()=>a,metadata:()=>r,toc:()=>l});const r=JSON.parse('{"id":"middleware/casbin-auth","title":"Casbin Auth","description":"Casbin auth middleware","source":"@site/docs/middleware/casbin-auth.md","sourceDirName":"middleware","slug":"/middleware/casbin-auth","permalink":"/docs/middleware/casbin-auth","draft":false,"unlisted":false,"editUrl":"https://github.com/labstack/echox/blob/master/website/docs/middleware/casbin-auth.md","tags":[],"version":"current","frontMatter":{"description":"Casbin auth middleware"},"sidebar":"docsSidebar","previous":{"title":"Body Limit","permalink":"/docs/middleware/body-limit"},"next":{"title":"Context Timeout","permalink":"/docs/middleware/context-timeout"}}');var s=n(4848),i=n(8453);const a={description:"Casbin auth middleware"},o="Casbin Auth",c={},l=[{value:"Dependencies",id:"dependencies",level:2},{value:"Implementation",id:"implementation",level:2},{value:"Usage",id:"usage",level:2},{value:"Example",id:"example",level:2},{value:"Full Casbin + JWT example",id:"full-casbin--jwt-example",level:3}];function d(e){const t={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(t.header,{children:(0,s.jsx)(t.h1,{id:"casbin-auth",children:"Casbin Auth"})}),"\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.a,{href:"https://github.com/casbin/casbin",children:"Casbin"})," is a powerful and efficient open-source access control library for Go. It provides support for enforcing authorization based on various models. So far, the access control models supported by Casbin are:"]}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:"ACL (Access Control List)"}),"\n",(0,s.jsx)(t.li,{children:"ACL with superuser"}),"\n",(0,s.jsx)(t.li,{children:"ACL without users: especially useful for systems that don't have authentication or user log-ins."}),"\n",(0,s.jsx)(t.li,{children:"ACL without resources: some scenarios may target for a type of resources instead of an individual resource by using permissions like write-article, read-log. It doesn't control the access to a specific article or log."}),"\n",(0,s.jsx)(t.li,{children:"RBAC (Role-Based Access Control)"}),"\n",(0,s.jsx)(t.li,{children:"RBAC with resource roles: both users and resources can have roles (or groups) at the same time."}),"\n",(0,s.jsx)(t.li,{children:"RBAC with domains/tenants: users can have different role sets for different domains/tenants."}),"\n",(0,s.jsx)(t.li,{children:"ABAC (Attribute-Based Access Control)"}),"\n",(0,s.jsx)(t.li,{children:"RESTful"}),"\n",(0,s.jsx)(t.li,{children:"Deny-override: both allow and deny authorizations are supported, deny overrides the allow."}),"\n"]}),"\n",(0,s.jsxs)(t.p,{children:["See ",(0,s.jsx)(t.a,{href:"https://casbin.org/docs/api-overview",children:"API Overview"}),".\nFor more information, see: ",(0,s.jsx)(t.a,{href:"https://casbin.org/docs/",children:"Casbin Documentation"}),"."]}),"\n",(0,s.jsx)(t.h2,{id:"dependencies",children:"Dependencies"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"go get -u github.com/casbin/casbin/v3\n"})}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-go",children:'import (\n  "github.com/casbin/casbin/v3"\n)\n'})}),"\n",(0,s.jsx)(t.h2,{id:"implementation",children:"Implementation"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-go",children:'// NewCasbinMiddleware returns middleware for [Casbin](https://casbin.org/).\nfunc NewCasbinMiddleware(enforcer *casbin.Enforcer, userGetter func(*echo.Context) (string, error)) echo.MiddlewareFunc {\n\treturn func(next echo.HandlerFunc) echo.HandlerFunc {\n\t\treturn func(c *echo.Context) error {\n\t\t\tusername, err := userGetter(c)\n\t\t\tif err != nil {\n\t\t\t\treturn echo.ErrUnauthorized.Wrap(err)\n\t\t\t}\n\t\t\tif pass, err := enforcer.Enforce(username, c.Request().URL.Path, c.Request().Method); err != nil {\n\t\t\t\treturn echo.ErrInternalServerError.Wrap(err)\n\t\t\t} else if !pass {\n\t\t\t\treturn echo.NewHTTPError(http.StatusForbidden, "access denied")\n\t\t\t}\n\t\t\treturn next(c)\n\t\t}\n\t}\n}\n'})}),"\n",(0,s.jsx)(t.h2,{id:"usage",children:"Usage"}),"\n",(0,s.jsx)(t.p,{children:"Middleware can be initialized like this:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-go",children:'e := echo.New()\nenforcer, err := casbin.NewEnforcer("casbin_auth_model.conf", "casbin_auth_policy.csv")\ne.Use(NewCasbinMiddleware(enforcer))\n'})}),"\n",(0,s.jsx)(t.h2,{id:"example",children:"Example"}),"\n",(0,s.jsxs)(t.p,{children:["Create a Casbin policy file ",(0,s.jsx)(t.code,{children:"auth_model.conf"}),":"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-ini",children:'[request_definition]\nr = sub, obj, act\n\n[policy_definition]\np = sub, obj, act\n\n[role_definition]\ng = _, _\n\n[policy_effect]\ne = some(where (p.eft == allow))\n\n[matchers]\nm = g(r.sub, p.sub) && keyMatch(r.obj, p.obj) && (r.act == p.act || p.act == "*")\n'})}),"\n",(0,s.jsxs)(t.p,{children:["Create a Casbin policy file ",(0,s.jsx)(t.code,{children:"auth_policy.csv"}),":"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-csv",children:"p, 1234567890, /dataset1/*, GET\np, alice, /dataset1/*, GET\np, alice, /dataset1/resource1, POST\np, bob, /dataset2/resource1, *\np, bob, /dataset2/resource2, GET\np, bob, /dataset2/folder1/*, POST\np, dataset1_admin, /dataset1/*, *\ng, cathy, dataset1_admin\n"})}),"\n",(0,s.jsx)(t.p,{children:"Authenticating user with JWT and authorizing access to resources based on Casbin policy."}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-go",children:'\te.Use(echojwt.JWT([]byte("secret")))               // JWT middleware does authentication\n\tjwtUser := func(c *echo.Context) (string, error) { // JWT user getter for Casbin authorization\n\t\ttoken, err := echo.ContextGet[*jwt.Token](c, "user")\n\t\tif err != nil {\n\t\t\treturn "", err\n\t\t}\n\t\treturn token.Claims.GetSubject()\n\t}\n\te.Use(NewCasbinMiddleware(ce, jwtUser)) // Casbin does authorization\n'})}),"\n",(0,s.jsx)(t.p,{children:"Try with:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:'curl -v "http://localhost:8080/dataset1/any" -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ"\n'})}),"\n",(0,s.jsx)(t.p,{children:"or authenticating user with Basic Auth and authorizing access to resources based on Casbin policy."}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-go",children:'\t// BasicAuth middleware does authentication\n\te.Use(middleware.BasicAuth(func(c *echo.Context, user string, password string) (bool, error) {\n\t\treturn subtle.ConstantTimeCompare([]byte(user), []byte("alice")) == 1 &&\n\t\t\tsubtle.ConstantTimeCompare([]byte(password), []byte("password")) == 1, nil\n\t}))\n\tbasicAuthUser := func(c *echo.Context) (string, error) { // basic auth user getter for Casbin authorization\n\t\tusername, _, _ := c.Request().BasicAuth() // NB: authorization (PASSWORD check) must be done somewhere!!!\n\t\treturn username, nil\n\t}\n\te.Use(newCasbinMiddleware(ce, basicAuthUser)) // Casbin does authorization\n'})}),"\n",(0,s.jsx)(t.p,{children:"Try with:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:'# should pass\ncurl -v -u "alice:password" http://localhost:8080/dataset1/any\n# should fail\ncurl -v -u "alice:password" http://localhost:8080/dataset2/resource2\n'})}),"\n",(0,s.jsx)(t.h3,{id:"full-casbin--jwt-example",children:"Full Casbin + JWT example"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-go",children:'package main\n\nimport (\n\t"log/slog"\n\t"net/http"\n\n\t"github.com/casbin/casbin/v3"\n\t"github.com/golang-jwt/jwt/v5"\n\techojwt "github.com/labstack/echo-jwt/v5"\n\t"github.com/labstack/echo/v5"\n)\n\n// NewCasbinMiddleware returns middleware for [Casbin](https://casbin.org/).\nfunc NewCasbinMiddleware(enforcer *casbin.Enforcer, userGetter func(*echo.Context) (string, error)) echo.MiddlewareFunc {\n\treturn func(next echo.HandlerFunc) echo.HandlerFunc {\n\t\treturn func(c *echo.Context) error {\n\t\t\tusername, err := userGetter(c)\n\t\t\tif err != nil {\n\t\t\t\treturn echo.ErrUnauthorized.Wrap(err)\n\t\t\t}\n\t\t\tif pass, err := enforcer.Enforce(username, c.Request().URL.Path, c.Request().Method); err != nil {\n\t\t\t\treturn echo.ErrInternalServerError.Wrap(err)\n\t\t\t} else if !pass {\n\t\t\t\treturn echo.NewHTTPError(http.StatusForbidden, "access denied")\n\t\t\t}\n\t\t\treturn next(c)\n\t\t}\n\t}\n}\n\n/*\nTest with:\ncurl -v "http://localhost:8080/dataset1/any" -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ"\n*/\nfunc main() {\n\te := echo.New()\n\n\tce, err := casbin.NewEnforcer("auth_model.conf", "auth_policy.csv")\n\tif err != nil {\n\t\tslog.Error("failed to initialize Casbin enforcer", "error", err)\n\t}\n\t\n\te.Use(echojwt.JWT([]byte("secret")))               // JWT middleware does authentication\n\tjwtUser := func(c *echo.Context) (string, error) { // JWT user getter for Casbin authorization\n\t\ttoken, err := echo.ContextGet[*jwt.Token](c, "user")\n\t\tif err != nil {\n\t\t\treturn "", err\n\t\t}\n\t\treturn token.Claims.GetSubject()\n\t}\n\te.Use(NewCasbinMiddleware(ce, jwtUser)) // Casbin does authorization\n\n\te.GET("/*", func(c *echo.Context) error {\n\t\treturn c.String(http.StatusOK, "Hello, World!")\n\t})\n\n\tif err := e.Start(":8080"); err != nil {\n\t\te.Logger.Error("failed to start server", "error", err)\n\t}\n}\n'})})]})}function u(e={}){const{wrapper:t}={...(0,i.R)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},8453:(e,t,n)=>{n.d(t,{R:()=>a,x:()=>o});var r=n(6540);const s={},i=r.createContext(s);function a(e){const t=r.useContext(i);return r.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function o(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),r.createElement(i.Provider,{value:t},e.children)}}}]);